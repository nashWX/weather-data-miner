{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'header.html' %}
<div class="report-page">
    <div class="container py-4">
        <div class="row content-wrapper mt-5">
            <div class="col-lg-5 col-md-6 col-12">
                <div class="warning-types position-relative">
                    <div class="warning-label">
                        <h5>new reports</h5>
                    </div>
                    <button class="subject-btn subject-btn-update" data-warning="tornado">
                        <span class="btn-content">
                            <span class="icon">
                                <svg height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M3.518 3.097C4.56 1.387 9.114 0 16.018 0c6.902 0 11.368 1.647 12.499 3.097 1.562 2.002-.88 6.735-8.333 11.355-6.355 3.938-11.04 7.769-7.292 9.29C21.818 27.364 17.06 32 17.06 32s0-3.097-3.125-4.129c-5.282-1.745-7.291-3.097-9.374-5.161-1.576-1.562-3.272-6.491 2.083-11.355 2.665-2.42-5.123-4.977-3.125-8.258zM27 4.032c0-1.657-4.925-3-11-3s-11 1.343-11 3 4.925 3 11 3 11-1.343 11-3z"
                                        fill="currentColor" fill-rule="evenodd" />
                                </svg>
                            </span>
                            <span class="no-report tornado-count">
                                {{amount_tornado_warnings}}
                            </span>
                            <span class="btn-text">
                                TORNADO Warnings
                            </span>
                        </span>
                    </button>
                    <button class="subject-btn subject-btn-update" data-warning="tstorm">
                        <span class="btn-content">
                            <span class="icon">
                                <svg version="1.0" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="1em"
                                    height="1em" viewBox="0 0 1257 1280">
                                    <path
                                        d="M663 1c-2.5.4-9 1.3-14.5 2-5.5.6-15.4 2.4-22 4-43.3 10.3-81.4 32.5-112.1 65.5l-10.2 10.9-13.3-6.6c-22.3-11-39.4-16.6-63.8-21-10.5-1.8-16.3-2.2-34.6-2.3-23.8 0-32.5.9-52 5.5-64.6 15.3-119.1 59-148 118.5-7.4 15.2-11.4 26.2-15.9 43.5l-3.3 12.5-4.9 1.4c-41.5 11.9-71.4 28.7-99.5 55.8-19.7 19.1-34 38.9-45.9 63.5C11.8 377.5 6 397.3 2.3 425c-7 52.3 9 112.6 41.7 156.5 32.9 44 78 73.5 131.1 85.5 28.5 6.4 65.1 6.7 93.7.6 26.2-5.6 55-17.6 75.9-31.7 7.3-5 10.1-5.7 14.9-3.9 6 2.3 28.2 6 42.9 7.2 24 1.8 52.2-1.1 75.6-7.8.9-.2 4.3 1.7 8 4.7 23.6 19.1 54.6 34.6 83.9 42.1 21.6 5.4 28.5 6.2 55 6.2 21.2 0 26.2-.3 37.4-2.3 37.5-6.7 70.1-21.2 100.5-44.9 8.2-6.4 8.4-6.5 11-4.9 34.2 20.1 65 29.9 102.7 32.8 24.9 1.9 50.8-.9 76-8.1 10.2-2.9 27.4-9.4 34.4-13 3.5-1.8 4.2-1.8 12.1-.4 12.2 2.1 44.3 2.9 58.1 1.4 41.7-4.5 80.2-20 112.8-45.3 45.1-35 75.9-87.9 83.4-142.8.9-6.3 2.1-14.4 2.6-18.1 1.3-8.5 1.3-21.3 0-29.2-.5-3.3-1.7-11.3-2.5-17.6-.9-6.3-3.1-17.4-5-24.5-23.3-89.5-101-155.4-193.9-164.4-6-.6-13-1.1-15.4-1.1-4.4 0-4.8-.3-17.6-12.8-7.2-7-17.9-16.4-23.9-20.8-31.4-23.6-69.6-38.4-109.2-42.6-13.4-1.4-11.5.1-20.5-15.4-20.9-35.8-53.9-66.8-91-85.4-27-13.5-45.7-18.9-79.5-23C681-.1 670.8-.3 663 1zM521.5 739.2c-2.2 2.1-6.4 17.2-39.5 142.3-25.2 95.2-36.8 140.9-36.4 142.7.7 3.4 3.9 5.8 7.6 5.8 1.6 0 21.5-4.5 44.4-10.1 24.2-5.9 42-9.7 42.5-9.2s-11.8 24.1-29.4 56.3c-16.7 30.5-48.2 88.2-70 128.1-41.5 75.9-42.2 77.4-37.9 81.1 3.9 3.5 5.9 3.9 9 2.1 5.6-3.4 399.3-375.7 399.9-378.2.8-3.4-.8-7.3-3.9-9-2.4-1.4-8.6-.9-67.5 5.3-35.6 3.7-66.5 7-68.5 7.3-2.7.4-3.9.2-4.3-.8-.3-.8 17.7-35.3 40-76.7 27.6-51.3 40.5-76.3 40.5-78.3 0-1.8-.9-3.9-2.3-5.3l-2.3-2.3-39-.7c-68.5-1.2-157.6-2.6-169.1-2.6-10.2 0-11.4.2-13.8 2.2z" />
                                </svg>
                            </span>
                            <span class="no-report tstorm-count">
                                {{amount_tstorm_warnings}}
                            </span>
                            <span class="btn-text">
                                T-Storms Warnings
                            </span>
                        </span>
                    </button>
                    <button class="subject-btn subject-btn-update" data-warning="flood">
                        <span class="btn-content">
                            <span class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="1em" height="1em"
                                    viewBox="0 0 100 69.453">
                                    <path
                                        d="M68.345 48.412c3.558 1.812 8.542 2.245 11.701.602 4.282-2.229 7.665-3.039 11.023-2.018.004-.053 0-.104.006-.156.195-1.186 1.277-1.995 2.433-1.803 1.14.17 1.917 1.276 1.737 2.467a2.236 2.236 0 01-.625 1.203c.584.291 1.568.658 2.996.88l.434-2.737c.336-2.172-1.21-3.591-2.174-3.872l-1.451-6.731c-.266-1.287-1.105-2.478-3.007-2.789l-3.462-.547-5.921-.938-3.523-.557c-1.891-.291-3.059.584-3.719 1.721l-3.462 5.954c-.994-.028-2.901.845-3.241 3.017l-.911 5.737c.377.17.762.354 1.166.567zm8.195-13.675c.339-.676.765-1.127 1.585-1.009l6.465 1.021.019.004 6.485 1.027c.806.139 1.071.701 1.194 1.446l1.061 5.289-9.725-1.539-.02-.005-9.707-1.537 2.643-4.697zm-5.981 8.854c.183-1.188 1.265-1.997 2.41-1.807 1.148.172 1.927 1.278 1.735 2.466-.185 1.177-1.267 1.988-2.411 1.805-1.147-.18-1.927-1.286-1.734-2.464zM56.944 19.599V3.188H45.833v6.594L34.762 0 2.777 28.188h5.556v19.026c3.528-1.311 7.012-.561 11.57 1.799 3.131 1.644 8.188 1.211 11.702-.602 4.883-2.563 7.509-1.95 12.629.327 3.91 1.749 7.472 1.755 11.426 0 2.117-.944 3.825-1.575 5.45-1.839V28.188h5.557l-9.723-8.589zM93.933 56.591c-4.379-2.686-8.391-2.149-13.887.71-3.159 1.644-8.144 1.21-11.701-.601-4.838-2.562-7.592-1.941-12.685.327-3.954 1.755-7.516 1.75-11.426 0-5.12-2.276-7.746-2.89-12.629-.327-3.513 1.811-8.57 2.244-11.702.601-5.525-2.859-9.466-3.396-13.833-.71 0 0-1.901 1.451-6.07 1.475v11.111c4.169-.024 6.07-1.474 6.07-1.474 4.367-2.688 8.309-2.151 13.833.708 3.131 1.644 8.188 1.211 11.702-.599 4.883-2.565 7.509-1.95 12.629.325 3.91 1.75 7.472 1.756 11.426 0 5.093-2.268 7.847-2.891 12.685-.325 3.558 1.81 8.542 2.242 11.701.599 5.496-2.859 9.508-3.396 13.887-.708 0 0 1.816 1.456 6.067 1.474V58.066c-4.251-.018-6.067-1.475-6.067-1.475z" />
                                </svg>
                            </span>
                            <span class="no-report flood-count">
                                {{amount_flood_warnings}}
                            </span>
                            <span class="btn-text">
                                FLOOD Warnings
                            </span>
                        </span>
                    </button>
                </div>
            </div>
            <div class="col-md-6 col-lg-7 col-12">
                <div class="warning-map">
                    <div class="last-update">
                        <h5>last update</h5>
                        <p class="last-time">
                            <span class="h">00</span>
                            <span class="m">:00:</span>
                            <span class="s">00</span>
                        </p>
                    </div>
                    <!-- <img src="/media/img/110148382341970_map.png" alt="center map"> -->
                    <img src="{{map_path}}" alt="center map" id="big-map">
                </div>
            </div>
        </div>
        <div class="row my-5">
            <div class="col-12">
                <center>
                    <div class="posts-label">
                        <h3 class="header-subtitle report-title">Location with new posts</h3>
                    </div>
                </center>

                <div id="content-container">
                    <div class="posts-container row d-none">

                    </div>
                </div>
                <center id="spinner" class="d-none">
                    <div class="lds-roller">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </center>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>

    Array.prototype.contains = function (obj1) {
        const elements = this;
        for (const obj2 of elements) {
           if(JSON.stringify(obj1) === JSON.stringify(obj2)) {
               return true;
           }
        }
        return false;
    }
    let flood = +"{{amount_flood_warnings}}";
    let tstorm = +"{{amount_tstorm_warnings}}";
    let tornado = +"{{amount_tornado_warnings}}";
    var last_update = "{{last_update}}";
    const timer_h = document.querySelector('.h');
    const timer_m = document.querySelector('.m');
    const timer_s = document.querySelector('.s');

    function hideLabel(hide=false) {
        if(hide && !document.querySelector('.posts-label').classList.contains('d-none')) {
            document.querySelector('.posts-label').classList.add('d-none');
        } else if(!hide) {
            document.querySelector('.posts-label').classList.remove('d-none');
        }
    }

    function lastUpdated() {
      const d1 = new Date(last_update);
      const d2 = new Date();
      const h = Math.max(0, d2.getHours() - d1.getHours());
      const m = Math.max(0, d2.getMinutes() - d1.getMinutes());
      const s = Math.max(0, d2.getSeconds() - d1.getSeconds());
      timer_h.innerText = `${h < 10 ? '0'+h : h}`;
      timer_m.innerText = `:${m < 10 ? '0'+m : m}:`;
      timer_s.innerText = `${s < 10 ? '0'+s : s}`;
    }

    var interval_id = setInterval(lastUpdated, 1000);



    hideLabel(true);
    

    const flood_count = document.querySelector('.flood-count');
    const tstorm_count = document.querySelector('.tstorm-count');
    const tornado_count = document.querySelector('.tornado-count');
    const big_map = document.querySelector('#big-map');
    const last_time = document.querySelector('.last-time');

    let old_warning_data = [];
    let selected_warning_type = null;

    async function subscribeWarningUpdate() {
        const response = await fetch('/warning-update');
        const interval = (1000 * 60 * 2);
        if (selected_warning_type) {
            const data = (await fetch(`/warning-list?type=${selected_warning_type}`).then(resp => resp.json())) || [];
            const partial_data = data.warnings.filter(item => !old_warning_data.contains(item))
            if(data.last_update) {
                last_update = data.last_update;
                clearInterval(interval_id);
                interval_id = setInterval(lastUpdated, 1000);
            }
            if (partial_data.length) {
                renderWarnings(partial_data, false);
                old_warning_data = [...old_warning_data, ...partial_data];
                big_map.setAttribute('src', data.map_path);
                hideLabel()
            } else if(!partial_data.length && !old_warning_data.length) {
                hideLabel(true);
            }
        }
        if (response.status === 502) {
            await subscribeWarningUpdate();
        } else if (response.status !== 200) {
            console.error(response.statusText);
            await new Promise((resolve) => setTimeout(resolve, interval));
            await subscribeWarningUpdate();
        } else {
            const data = await response.json();
            if(!selected_warning_type && data.last_update) {
                last_update = data.last_update;
                clearInterval(interval_id);
                interval_id = setInterval(lastUpdated, 1000);
            } 

            if (flood !== data.amount_flood_warnings) {
                flood = data.amount_flood_warnings;
                flood_count.innerText = flood;
                flood_count.parentElement.parentElement.classList.add('got-update');
            }

            if (tstorm !== data.amount_tstorm_warnings) {
                tstorm = data.amount_tstorm_warnings;
                tstorm_count.innerText = tstorm;
                tstorm_count.parentElement.parentElement.classList.add('got-update');
            }

            if (tornado !== data.amount_tornado_warnings) {
                tornado = data.amount_tornado_warnings;
                tornado_count.innerText = tornado;
                tornado_count.parentElement.parentElement.classList.add('got-update');
            }

            await new Promise((resolve) => setTimeout(resolve, interval));
            await subscribeWarningUpdate();
        }
    }

    subscribeWarningUpdate();

    const spinner = document.querySelector("#spinner");
    const container = document.querySelector("#content-container");

    document.querySelectorAll('.subject-btn').forEach(function (button) {
        button.addEventListener('click', async (e) => {
            e.preventDefault();
            button.classList.remove('got-update')
            spinner.classList.remove('d-none');
            const { warning: warningType } = e.currentTarget.dataset;
            const data = await fetch(`/warning-list?type=${warningType}`).then(resp => resp.json());
            spinner.classList.add('d-none');
            old_warning_data = data.warnings;
            big_map.setAttribute('src', data.map_path);
            selected_warning_type = warningType;
            renderWarnings(old_warning_data);
            clearInterval(interval_id);
            interval_id = setInterval(lastUpdated, 1000);

            if(old_warning_data.length) {
                console.log('warning label show...')
                hideLabel()
            } else {
                console.log('warning label show...2')
                hideLabel(true);
            }
        });
    });

    function renderWarnings(warnings = [], fullupdate = true) {
        const postContainer = document.querySelector(".posts-container");
        postContainer.classList.remove('d-none');

        if (fullupdate) {
            postContainer.innerHTML = '';
            for (const warning of warnings) {
                const div = document.createElement('div');
                div.classList.add(..."col-xl-3 col-lg-4 col-md-6 col-12 px-0 mb-xs-4".split(" "))
                const item = `
                        <a href="${warning.location.insta_url}" class="weather-info ${warning.warning_type}" target="_blank">
                            <div class="time-stamp">
                                <div class="starttime">${warning.start}</div>
                                <div class="endtime">${warning.end}</div>
                            </div>
                            <div class="map">
                                <img src="${warning.location.location_map ?? '/media/img/2683391338749083463_map.png'}" alt="map">
                            </div>
                            <div class="population">${warning.location.popu}</div>
                            <div class="locality">
                                <p>${warning.location.name}</p>
                            </div>
                        </a>
                    `;
                div.innerHTML = item;
                postContainer.append(div);
            }
        } else {
            for (const warning of warnings) {
                const div = document.createElement('div');
                div.classList.add(..."col-xl-3 col-lg-4 col-md-6 col-12 px-0 mb-xs-4".split(" "))
                const item = `
                        <a href="${warning.location.insta_url}" class="weather-info ${warning.warning_type}" target="_blank">
                            <div class="time-stamp">
                                <div class="starttime">${warning.start}</div>
                                <div class="endtime">${warning.end}</div>
                            </div>
                            <div class="map">
                                <img src="${warning.location.location_map}" alt="map">
                            </div>
                            <div class="population">${warning.location.popu}</div>
                            <div class="locality">
                                <p>${warning.location.name}</p>
                            </div>
                        </a>
                    `;
                div.innerHTML = item;
                postContainer.prepend(div);

            }
        }
        const weatherInfos = document.querySelectorAll('.weather-info');
        if(!weatherInfos.length && !postContainer.classList.contains('d-none')) {
            postContainer.classList.add('d-none');
        }
        weatherInfos.forEach(item => {
            item.removeEventListener('click', handleClick);
            item.addEventListener('click', handleClick);
        });
    }

    const handleClick = (e) => {
        if(!e.currentTarget.classList.contains('visited')) {
            e.currentTarget.classList.add('visited');
        }
    }
</script>
{% endblock %}